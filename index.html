<script>
    // --- ESTADO DA APLICAÇÃO ---
    let currentPrompt = '';
    let displayedMovies = [];
    const COMMENT_TRUNCATE_LENGTH = 180; 
    let appDisplayLanguage = 'pt'; 

    // --- CONSTANTES DE API ---
    const OMDB_KEY = '62986a1f'; 
    const TMDB_KEY = '188491e52fd2bdc583bba0b7a90bfda3'; 
    const GEMINI_API_KEY = '__GEMINI_API_KEY__';  // placeholder para ser injetado pelo workflow
    const WATCHMODE_API_KEY = 'Fc6ndanwCdU4wKQYbCLZLht8x79SfZFCp765TUTT'; 

    // ...

    /**
     * Usa Gemini para sugerir títulos de filmes e detectar idioma.
     */
    async function suggestTitlesWithGemini(prompt) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const system = `Analise o idioma da descrição e retorne JSON no formato:
        {"language":"pt|en","titles":["...", "...", "..."]}.
        Sugira 4-6 FILMES REAIS, nada genérico.`;

        const body = {
            contents: [
                {
                    role: "user",
                    parts: [{ text: `${system}\n\nDescrição: '${prompt}'` }]
                }
            ],
            generationConfig: { response_mime_type: "application/json" }
        };

        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error(`Gemini HTTP ${res.status}`);
        const data = await res.json();

        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
        return JSON.parse(text);
    }

    // --- no fetchMovieResults ---
    async function fetchMovieResults(prompt, excludeTitles) {
        const moviesToReturn = [];
        const sourceFilter = document.querySelector('input[name="source"]:checked').value;
        const preferenceFilter = document.querySelector('input[name="preference"]:checked').value;

        // ...

        // --- Usar Gemini para gerar títulos ---
        let suggestedTitles = [];
        try {
            const result = await suggestTitlesWithGemini(prompt);
            appDisplayLanguage = (result.language || '').toLowerCase().includes('pt') ? 'pt' : 'en';
            suggestedTitles = Array.isArray(result.titles) ? result.titles : [];
        } catch (e) {
            console.error('Erro Gemini:', e);
            suggestedTitles = [prompt]; // fallback
        }

        
    }
</script>
